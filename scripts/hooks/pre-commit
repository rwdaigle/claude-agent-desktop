#!/usr/bin/env bash
# Pre-commit hook: runs lint, format, and typecheck before each commit

set -e

echo "Running pre-commit checks..."

# Get the project root using git
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Run lint with auto-fix first
echo ""
echo "Running lint with auto-fix..."
if bun run lint --fix; then
    echo "Lint passed."
else
    echo ""
    echo "Lint failed. Please fix the errors above and try again."
    exit 1
fi

# Run prettier with auto-fix
echo ""
echo "Running format with auto-fix..."
if bun run format; then
    echo "Format passed."
else
    echo ""
    echo "Format failed. Please fix the errors above and try again."
    exit 1
fi

# Stage any files that were auto-fixed by lint or prettier
git diff --name-only | while read -r file; do
    if [[ -f "$file" ]]; then
        git add "$file"
    fi
done

# Run typecheck
echo ""
echo "Running typecheck..."
if bun run typecheck; then
    echo "Typecheck passed."
else
    echo ""
    echo "Typecheck failed. Please fix the type errors above and try again."
    exit 1
fi

echo ""
echo "All pre-commit checks passed!"
